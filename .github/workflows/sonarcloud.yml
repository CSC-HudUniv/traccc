


jobs:
  sonarUbuntu_CUDA:
      name: Sonar-Ubuntu-CUDA
      runs-on: [self-hosted, linux]
      env:
        SONAR_SCANNER_VERSION: 4.7.0.2747
        SONAR_SERVER_URL: "https://sonarcloud.io"
        BUILD_WRAPPER_OUT_DIR: build_wrapper_output_directory # Directory where build-wrapper output will be placed
      steps:
        - uses: actions/checkout@v2
          with:
            fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

        - name: Set up JDK 11
          uses: actions/setup-java@v1
          with:
            java-version: 11

        - name: Install sonar-scanner and build-wrapper
          uses: SonarSource/sonarcloud-github-c-cpp@v1

        - name: Run build-wrapper
          run: |
            source /cvmfs/sft.cern.ch/lcg/views/LCG_103/x86_64-centos9-gcc11-opt/setup.sh
            cd ../
            mkdir -p ./traccc-build && cd ./traccc-build
            cmake -S ../traccc -B . -D CMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc -D TRACCC_BUILD_CUDA=TRUE -D VECMEM_BUILD_CUDA_LIBRARY=TRUE -D CMAKE_CUDA_ARCHITECTURES="52" -D TRACCC_BUILD_TESTING=TRUE
            cd ../traccc 
            build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUT_DIR }} cmake --build ../traccc-build -j4 --clean-first
          shell: bash --noprofile --norc -o pipefail {0}
  
        - name: Run tests to generate coverage statistics
          env:
            TRACCC_TEST_DATA_DIR: /home/ymanjra/traccc-projects/traccc/data/
          run: |
            find ../traccc-build/bin -maxdepth 1 -name "traccc_test*" -executable -exec '{}' ';'
        - name: Collect coverage into one XML report
          run: |
            gcovr --sonarqube > coverage.xml
            
        - name: Run sonar-scanner
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          run: |
            sonar-scanner \
               --define sonar.host.url="${{ env.SONAR_SERVER_URL }}" --define sonar.cfamily.build-wrapper-output="${{ env.BUILD_WRAPPER_OUT_DIR }}" \
               --define sonar.cfamily.llvm-cov.reportPath=coverage.xml
